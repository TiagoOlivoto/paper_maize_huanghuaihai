y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
# zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 28,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
# zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
# zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29,
y.max = 30,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
# zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
# zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 30,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
# zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29.5,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.44)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29.5,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
north2(zoom, 0.9, .15)
north2(zoom, 0.9, .1)
zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.55)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29.5,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
north2(zoom, 0.9, .1)
# china <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
theme(legend.position = "none")
png("figs/fig1_map.png", width = 10, height = 7, units = "in", res = 600)
# china <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
theme(legend.position = "none")
dev.off()
png("figs/fig1_map2.png", width = 10, height = 7, units = "in", res = 600)
zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.55)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29.5,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42))
north2(zoom, 0.9, .1)
dev.off()
zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.55)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29.5,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42)) +
labs(x = "Longitude",
y = "Latitude")
png("figs/fig1_map2.png", width = 10, height = 7, units = "in", res = 600)
zoom <-
ggplot(data = china) +
geom_sf(aes(fill = Province), size = 0.2) +
ggthemes::theme_map() +
scale_fill_discrete(na.value = "gray97",
labels = c(unique(locs$Province), "others")) +
geom_point(data = locs,
aes(x = Lon, y = Lat, size = Altitude),
color = "black",
fill = "red",
shape = 21) +
geom_label_repel(data = locs,
aes(label = Location,
x = Lon,
y = Lat),
fill = "green",
color = "black",
segment.color = 'black',
force = 38,
size = 3) +
theme(legend.position = c(0.95, 0.1)) +
theme_minimal() +
theme(legend.position = c(.95, 0.55)) +
scalebar(dist = 200,
x.min = 109,
x.max = 128,
y.min = 29.5,
y.max = 42,
dist_unit = "km",
transform = TRUE,
model = "WGS84") +
xlim(c(109, 128)) +
ylim(c(28, 42)) +
labs(x = "Longitude",
y = "Latitude")
north2(zoom, 0.9, .1)
dev.off()
china <-
ne_states(country = "Asia",
returnclass = "sf")
ne_coastline() |> plot()
ne_coastline(returnclass = "sf") |> plot()
install.packages("NbClust")
id_var <- names(env_wider)[10:ncol(env_wider)]
df_traits <-
import("data/df_traits.csv") |>
metan::as_factor(1:6)
# long data
df_traits_long <-
df_traits |>
pivot_longer(GMC:HSW)
# grain yield mean in each environment
df_gy <-
df_traits |>
mean_by(ME, YEAR, .vars = GY)
# genotypic variance in each mega-environment
df_var_gy <-
df_traits |>
group_by(YEAR, ME) |>
do(lmer(GY ~(1|GEN), data = .) |>
tidy(effects = "ran_pars") |>
filter(group == "GEN") |>
transmute(var = estimate^2))
id_var <- names(env_wider)[10:ncol(env_wider)]
env_data <- readRDS("data/env_data.Rdata")
info <-
env_data |>
dplyr::select(env, LON, LAT) |>
mean_by(env)
df_gy_loc <-
df_traits |>
mean_by(LOC, .vars = GY)
env_wider <-
env_data |>
select(env, year, daysFromStart, TMED:RTA) |>
pivot_wider(names_from = "year",
values_from = TMED:RTA) |>
left_join(info) |>
relocate(LON, LAT, .after = env) |>
mutate(MM = 1,
DD = 1,
DOY = 1,
YYYYMMDD = 1,
YEAR = 1,
.after = env) |>
left_join(df_gy_loc, by = c("env" = "LOC"))
saveRDS(env_wider, "data/env_wider.Rdata")
id_var <- names(env_wider)[10:ncol(env_wider)]
EC <-
W_matrix(env.data = env_wider,
env.id = "env",
var.id = id_var,
by.interval = TRUE,
time.window = c(0, 30, 60, 90, 120, 150),
QC = TRUE,
sd.tol = 3)
saveRDS(EC, "data/EC.Rdata")
distances <-
env_kernel(env.data = EC,
gaussian = TRUE)
d <-
superheat(distances[[2]],
heat.pal = c("#b35806", "white", "#542788"),
pretty.order.rows = TRUE,
pretty.order.cols = TRUE,
col.dendrogram = TRUE,
legend.width = 4,
left.label.size = 0.1,
bottom.label.text.size = 5,
bottom.label.size = 0.2,
bottom.label.text.angle = 90,
legend.text.size = 17,
heat.lim = c(0, 1),
padding = 0.5,
legend.height=0.2)
NbClust::NbClust(distances[[2]])
NbClust::NbClust(distances[[2]], method = "average")
NbClust::NbClust(distances[[2]], method = "average", k = 3)
distances[[2]]
NbClust::NbClust(diss = 1 - distances[[2]], method = "average", k = 3)
NbClust::NbClust(diss = 1 - distances[[2]], method = "average")
1 - distances[[2]]
set.seed(1)
x<-rbind(matrix(rnorm(100,sd=0.1),ncol=2),
matrix(rnorm(100,mean=1,sd=0.2),ncol=2),
matrix(rnorm(100,mean=5,sd=0.1),ncol=2),
matrix(rnorm(100,mean=7,sd=0.2),ncol=2))
res<-NbClust(x, distance = "euclidean", min.nc=2, max.nc=8,
method = "complete", index = "ch")
library(NbClust)
set.seed(1)
x<-rbind(matrix(rnorm(100,sd=0.1),ncol=2),
matrix(rnorm(100,mean=1,sd=0.2),ncol=2),
matrix(rnorm(100,mean=5,sd=0.1),ncol=2),
matrix(rnorm(100,mean=7,sd=0.2),ncol=2))
res<-NbClust(x, distance = "euclidean", min.nc=2, max.nc=8,
method = "complete", index = "ch")
res
