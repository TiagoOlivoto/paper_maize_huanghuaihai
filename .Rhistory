# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
ggsave("figs/fig5_typology_vpd.pdf", width = 12, height = 7)
# plot the distribution of envirotypes for dbp
variable <- "dbp"
p1 <-
out2 |>
subset(var == variable) |> # change the variable here
ggplot() +
geom_bar(aes(x=Freq, y=env,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_grid(me~interval, scales = "free", space = "free")+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom')
# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
ggsave("figs/fig6_typology_dbp.pdf", width = 12, height = 7)
# plot the distribution of envirotypes for dbp
variable <- "dbp"
p1 <-
out2 |>
subset(var == variable) |> # change the variable here
ggplot() +
geom_bar(aes(x=Freq, y=env,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_grid(me~interval, scales = "free", space = "free")+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom')
# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
names.window <- c('1-intial growing','2-leaf expansion I','3-leaf expansion II','4-flowering','5-grain filling', "")
out <-
env_typing(env.data = env_data,
env.id = "env",
var.id = c("trange", "tmax", "tmin", "dbp", "etp", "vpd"),
by.interval = TRUE,
time.window = c(0, 15, 35, 65, 90, 120),
names.window = names.window)
out2 <-
separate(out,
env.variable,
into = c("var", "freq"),
sep = "_",
extra = "drop") |>
mutate(me = case_when(env %in% me1 ~ "ME1",
env %in% me2 ~ "ME2",
env %in% me3 ~ "ME3",
env %in% me4 ~ "ME4"))
# plot the distribution of envirotypes for dbp
variable <- "vpd"
p1 <-
out2 |>
subset(var == variable) |> # change the variable here
ggplot() +
geom_bar(aes(x=Freq, y=env,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_grid(me~interval, scales = "free", space = "free")+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom')
# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
ggsave("figs/fig5_typology_vpd.pdf", width = 12, height = 7)
# plot the distribution of envirotypes for dbp
variable <- "dbp"
p1 <-
out2 |>
subset(var == variable) |> # change the variable here
ggplot() +
geom_bar(aes(x=Freq, y=env,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_grid(me~interval, scales = "free", space = "free")+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom')
# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
ggsave("figs/fig6_typology_tmax.pdf", width = 12, height = 7)
id_var <- names(env_data)[10:23]
EC <- W_matrix(env.data = env_data,
by.interval = TRUE,
statistic = 'quantile',
time.window = c(0, 15, 35, 65, 90, 120))
distances <-
env_kernel(env.data = EC,
Y = df_gy$GY,
gaussian = TRUE)
d <-
superheat(distances[[2]],
heat.pal = c("#b35806", "white", "#542788"),
pretty.order.rows = TRUE,
pretty.order.cols = TRUE,
col.dendrogram = TRUE,
legend.width = 4,
left.label.size = 0.1,
bottom.label.text.size = 5,
bottom.label.size = 0.2,
bottom.label.text.angle = 90,
legend.text.size = 17,
heat.lim = c(0, 1),
padding = 0.5,
legend.height=0.2)
plot(d$plot)
ggsave(filename = "figs/fig2_heat_env.pdf",
plot = d$plot,
width = 10,
height = 10)
#
me1 <- c("GC2020", "SZ2020", "JN2019", "DZ2020", "HD2020")
me2 <- c("GC2019", "SZ2019", "DZ2019", "HD2019", "JS2019",
"NY2019", "LZ2019", "SX2019")
me3 <- c("YC2019", "YC2020")
me4 <- set_difference(as.character(unique(df_traits$ENV)), me1, me2, me3)
# Include a column to mega-environment
df_traits <-
df_traits |>
mutate(me = case_when(ENV %in% me1 ~ "ME1",
ENV %in% me2 ~ "ME2",
ENV %in% me3 ~ "ME3",
ENV %in% me4 ~ "ME4"))
env_data_me <-
env_data |>
mutate(me = case_when(env %in% me1 ~ "ME1",
env %in% me2 ~ "ME2",
env %in% me3 ~ "ME3",
env %in% me4 ~ "ME4"))
# long format for climate data
env_data_d <-
env_data_me |>
remove_cols(env, prec, LON:YYYYMMDD, daysFromStart) |>
pivot_longer(-me)
# long format for grain yield
df_gy_dist <-
df_traits |>
select(me, GY) |>
mutate(name = "GY", .after = me) |>
rename(value = GY)
prec <-
env_data_me %>%
sum_by(env, .vars = prec)
# compute the mean by environment and year
pca <-
env_data_me |>
remove_cols(me, prec, LON:YYYYMMDD, daysFromStart) %>%
pivot_longer(-env) %>%
means_by(env, name) %>%
pivot_wider(names_from = name, values_from = value) %>%
# set_names(c("env", varnames)) %>%
left_join(prec, by = "env") %>%
left_join(df_gy,  by = c("env" = "ENV")) %>%
left_join(df_var,  by = c("env" = "ENV")) %>%
mutate(me = case_when(env %in% me1 ~ "ME1",
env %in% me2 ~ "ME2",
env %in% me3 ~ "ME3",
env %in% me4 ~ "ME4")) |>
as.data.frame() |>
column_to_rownames("env")
# compute the PCA with
pca_model <- PCA(pca,
quali.sup = 17,
graph = FALSE)
fviz_pca_biplot(pca_model,
repel = TRUE,
habillage = 17,
col.var = "gray40",
title = NULL) +
coord_equal()
ggsave("figs/fig4_pca.pdf", width = 7, height = 7)
names.window <- c('1-intial growing','2-leaf expansion I','3-leaf expansion II','4-flowering','5-grain filling', "")
out <-
env_typing(env.data = env_data,
env.id = "env",
var.id = c("trange", "tmax", "tmin", "dbp", "etp", "vpd"),
by.interval = TRUE,
time.window = c(0, 15, 35, 65, 90, 120),
names.window = names.window)
out2 <-
separate(out,
env.variable,
into = c("var", "freq"),
sep = "_",
extra = "drop") |>
mutate(me = case_when(env %in% me1 ~ "ME1",
env %in% me2 ~ "ME2",
env %in% me3 ~ "ME3",
env %in% me4 ~ "ME4"))
# plot the distribution of envirotypes for dbp
variable <- "vpd"
p1 <-
out2 |>
subset(var == variable) |> # change the variable here
ggplot() +
geom_bar(aes(x=Freq, y=env,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_grid(me~interval, scales = "free", space = "free")+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom')
# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
ggsave("figs/fig5_typology_vpd.pdf", width = 12, height = 7)
# plot the distribution of envirotypes for dbp
variable <- "dbp"
p1 <-
out2 |>
subset(var == variable) |> # change the variable here
ggplot() +
geom_bar(aes(x=Freq, y=env,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_grid(me~interval, scales = "free", space = "free")+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom')
# by mega environment
p2 <-
out2 |>
subset(var == variable) |> # change the variable here
sum_by(me, freq, interval) |>
ggplot() +
geom_bar(aes(x=Freq, y=me,fill=freq),
position = "fill",
stat = "identity",
width = 1,
color = "white",
size=.2)+
facet_wrap(~interval, nrow = 1)+
scale_y_discrete(expand = c(0,0))+
scale_x_continuous(expand = c(0,0))+
xlab('Relative Frequency of Occurence')+
ylab("Environment")+
labs(fill='Envirotype')+
theme(axis.title = element_text(size=12),
legend.text = element_text(size=9),
strip.text = element_text(size=12),
legend.title = element_text(size=12),
strip.background = element_rect(fill="gray95",size=1),
legend.position = 'bottom') +
scale_fill_discrete(direction = 1)
arrange_ggplot(p1, p2,
heights = c(0.85, 0.15),
tag_levels = "a",
guides = "collect")
ggsave("figs/fig6_typology_tmax.pdf", width = 12, height = 7)
# Chunk 1: global_options
knitr::opts_chunk$set(cache = TRUE, comment = "##", collapse = TRUE)
# Chunk 2
library(EnvRtype)
library(rio)
library(factoextra)
library(FactoMineR)
library(ggrepel)
library(ggh4x)
library(superheat)
library(ggridges)
library(corrr)
library(tidyverse)
library(metan)
library(rnaturalearth)
my_theme <-
theme_bw() +
theme(panel.spacing = unit(0, "cm"),
panel.grid = element_blank(),
legend.position = "bottom")
# Chunk 3
df_traits <-
import("https://bit.ly/df_traits") |>
metan::as_factor(1:3)
# grain yield mean in each environment
df_gy <-
df_traits |>
means_by(ENV, .vars = GY)
df_var <-
df_traits |>
means_by(ENV, GEN, .vars = GY) |>
var_by(ENV) |>
rename(VAR = GY)
