% Supplementary figures 


```{r global_options, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      comment = "##",
                      collapse = TRUE,
                      warning = FALSE,
                      message = FALSE)
xaringanExtra::use_panelset()
```

\renewcommand{\figurename}{Fig. S}

```{r warning=FALSE, message=FALSE, echo=FALSE}
library(EnvRtype)
library(rio)
library(factoextra)
library(FactoMineR)
library(ggrepel)
library(ggh4x)
library(superheat)
library(ggridges)
library(metan)
library(rnaturalearth)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(tidyverse)
library(lubridate)

my_theme <- 
  theme_bw() +
  theme(panel.spacing = unit(0, "cm"),
        panel.grid = element_blank(),
        legend.position = "bottom")
```




```{r}
real <- 
  import("data/real_climate_data.xlsx") |> 
  mutate(data = ymd(data))


np <-
  get_weather(env.id = "Shenzhou",
              lat = 37.89,
              lon = 115.71,
              start.day = "01/05/2019",
              end.day = "30/10/2020") |> 
  param_radiation(merge = TRUE) |> 
  dplyr::select(env, 
                data = YYYYMMDD,
                tmed_np = T2M,
                tmax_np = T2M_MAX,
                tmin_np = T2M_MIN,
                rh_np = RH2M,
                prec_np = PRECTOT,
                n_np = n)

correlation <- 
  np |> 
  right_join(real) |> 
  dplyr::select(env, data, matches("real|np")) |> 
  pivot_longer(-c(env, data)) |> 
  separate(name, into = c("var", "method")) |> 
  pivot_wider(names_from = method, values_from = value)


ggplot(correlation, aes(np, real)) + 
  facet_wrap(~var, scales = "free") +
  geom_point(size = 2, alpha = 0.6) +
  geom_smooth(method = "lm")

library(metan)

correlation |> 
  group_by(var) |> 
  doo(~corr_coef(., np, real)[["cor"]] |> 
        as.data.frame()) |> 
  distinct(var, .keep_all = TRUE) |> 
  dplyr::select(var, real)

```




# Dataset
```{r}
df_traits <- 
  import("data/df_traits.csv") |>
  metan::as_factor(1:6)

# long data
df_traits_long <- 
  df_traits |> 
  pivot_longer(GMC:HSW)


# grain yield mean in each environment
df_gy <-
  df_traits |>
  mean_by(ME, YEAR, .vars = GY)

# genotypic variance in each mega-environment
df_var_gy <- 
  df_traits |>
  group_by(YEAR, ME) |> 
  do(lmer(GY ~ (1|GEN), data = .) |>
       tidy(effects = "ran_pars") |> 
       filter(group == "GEN") |> 
       transmute(var = estimate^2))

```




# Figure S1

```{r fig.cap="biplot for PCA"}
env_data <- 
  readRDS("data/env_data.Rdata") |> 
    mutate(me = case_when(
    env %in% c("Yicheng") ~ "ME1",
    env %in% c("Suixi", "Jieshou", "Nanyang") ~ "ME2",
    env %in% c("Shenzhou", "Gaocheng", "Handan", "Dezhou") ~ "ME3",
    env %in% c("Laizhou", "Jinan") ~ "ME4"
  ),
  .after = env)

env_data_m <- 
  env_data |> 
  select(-daysFromStart) |> 
  mean_by(env, .vars = T2M:RTA) |> 
  column_to_rownames("env")

# compute the PCA with
pca_model <- PCA(env_data_m,
                 quali.sup = 1,
                 graph = FALSE)

fviz_contrib(pca_model, "var")


```




```{r}
id_var <- names(env_data)[11:ncol(env_data)]

names.window <- c('May','June','July','August','September', "October")

out <- 
  env_data |> 
  select(-c(env, year)) |> 
  rename(env = me) |> 
  env_typing(env.id = "env",
             var.id = id_var,
             by.interval = TRUE,
             time.window = c(0, 15, 35, 65, 90, 120),
             names.window = names.window,
             quantiles = c(.01, .25, .50, .75, .975, .99)) |> 
  separate(env.variable,
           into = c("var", "freq"),
           sep = "_",
           extra = "drop")

```



# Figure S2

```{r fig.cap="Quantiles for Extraterrestrial radiation over six months observed in the delineated mega-environments", fig.width=13, fig.height=4}
# plot the distribution of envirotypes for dbp
variable <- "RTA"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()


```




# Figure S3
```{r fig.cap="Quantiles for daylight hours over six months observed in the delineated mega-environments", fig.width=13, fig.height=4}
# plot the distribution of envirotypes for dbp
variable <- "N"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()

```



# Figure S4
```{r fig.cap="Quantiles for deficit by precipitation over six months observed in the delineated mega-environments", fig.width=13, fig.height=4}
variable <- "PETP"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()



```





# Figure S5
```{r fig.cap="Quantiles for vapor pressure deficit over six months observed in the delineated mega-environments", fig.width=13, fig.height=4}
variable <- "VPD"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()

```








# Figure S6 {-}
```{r fig.width=12, fig.cap="Phenotypic correlation between the studied traits within ME1 (A), ME2 (B), and ME3 (C), and ME4 (D).", echo=FALSE}

mgidi_mod <- readRDS("data/mgidi.Rdata")
c1 <- mgidi_mod$mgidi[[1]]$cormat
c2 <- mgidi_mod$mgidi[[2]]$cormat
c3 <- mgidi_mod$mgidi[[3]]$cormat
c4 <- mgidi_mod$mgidi[[4]]$cormat


corM1p <- 
  c1 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)
corM2p <- 
  c2 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)
corM3p <- 
  c3 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)
corM4p <- 
  c4 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)


arrange_ggplot(corM1p, corM2p, corM3p, corM4p,
               guides = "collect",
               tag_levels = "A")

bind_cols(corr_focus(c1, GY) |> rename(GY_ME1 = GY), 
          corr_focus(c2, GY)[,2] |> rename(GY_ME2 = GY),
          corr_focus(c3, GY)[,2] |> rename(GY_ME3 = GY),
          corr_focus(c4, GY)[,2] |> rename(GY_ME4 = GY)) 
```

# Figure S7 {-}
```{r fig.cap="Mantel's correlation between the phenotypic correlation matrices observed in each mega-environment", echo=FALSE}

pairs_mantel(as.lpcor(c1, c2, c3, c4),
             names = c("ME1", "ME2", "ME3", "ME4"))
```



# Figure S8 {-}
```{r fig.width=10, fig.height=10, fig.cap="The strengths and weaknesses view of the selected genotypes is shown as the proportion of each factor on the computed multi-trait stability index (MTSI). The smallest the proportion explained by a factor (closer to the external edge), the closer the traits within that factor are to the ideotype. The dashed line shows the theoretical value if all the factors had contributed equally.", echo=FALSE}

m1 <- plot(mgidi_mod$mgidi[[1]], type = "contribution")
m2 <- plot(mgidi_mod$mgidi[[2]], type = "contribution")
m3 <- plot(mgidi_mod$mgidi[[3]], type = "contribution")
m4 <- plot(mgidi_mod$mgidi[[4]], type = "contribution")

arrange_ggplot(m1, m2, m3, m4,
               tag_levels = "A",
               ncol = 2)
```



# Figure S9 {- .panelset}

## ME1  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME1", echo=FALSE}
ME1 <- mgidi_mod$mgidi[[1]]$sel_gen
ME2 <- mgidi_mod$mgidi[[2]]$sel_gen
ME3 <- mgidi_mod$mgidi[[3]]$sel_gen
ME4 <- mgidi_mod$mgidi[[4]]$sel_gen

mean_me1 <- 
  df_traits |> 
    filter(ME == "ME1") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME1, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_all <- mean_by(mean_me1, name, sense)


ggplot(mean_me1, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_all,
             color = "blue") +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```


## ME2  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME2", echo=FALSE}
mean_me2 <- 
  df_traits |> 
  filter(ME == "ME2") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME2, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_me2 <- mean_by(mean_me2, name, sense)


ggplot(mean_me2, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_me2,
             color = "blue") +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```


## ME3  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME3", echo=FALSE}
mean_me3 <- 
  df_traits |> 
  filter(ME == "ME3") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME3, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_me3 <- mean_by(mean_me3, name, sense)


ggplot(mean_me3, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_me3,
             linetype = 2) +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```

## ME4  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME4", echo=FALSE}
mean_me4 <- 
  df_traits |> 
  filter(ME == "ME4") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME4, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_me4 <- means_by(mean_me4, name, sense)


ggplot(mean_me4, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_me4,
             color = "blue") +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```



# Figure S10  {-}
```{r fig.width=12, fig.height=8, echo=FALSE}
ge_plot(df_traits, LOC, GEN, GY,
        order_g = paste0("G", 1:26))
```


# Figure S11  {-}
```{r fig.width=12, fig.height=6, echo=FALSE}
ge_plot(df_traits, ME, GEN, GY,
        order_g = paste0("G", 1:26))
```

