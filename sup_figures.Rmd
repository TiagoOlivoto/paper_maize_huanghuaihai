% Supplementary figures 


```{r global_options, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      comment = "##",
                      collapse = TRUE,
                      warning = FALSE,
                      message = FALSE)
xaringanExtra::use_panelset()
```

\renewcommand{\figurename}{Fig. S}

```{r warning=FALSE, message=FALSE, echo=FALSE}
library(EnvRtype)
library(rio)
library(factoextra)
library(FactoMineR)
library(ggrepel)
library(ggh4x)
library(superheat)
library(ggridges)
library(metan)
library(rnaturalearth)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(tidyverse)
library(lubridate)

my_theme <- 
  theme_bw() +
  theme(panel.spacing = unit(0, "cm"),
        panel.grid = element_blank(),
        legend.position = "bottom")
```


# Figure S1 {-}

```{r echo=FALSE, fig.cap="NASA/POWER estimates vs observed values. (A) Relationship between NASA/POWER estimates and observed values (observed in Shenzhou) for daylight hours (n), rainfall precipitation (prec), relative humidity (rh), maximum air temperature (tmax), average air temperature (tmed), and minimum air temperature (tmin); (B) NASA/POWER vs observed values for accumulated rainfall in three different locations.", fig.width=7, fig.height=9, message=FALSE, warning=FALSE}
real <- 
  import("data/real_climate_data.xlsx") |> 
  mutate(data = ymd(data))


np <-
  get_weather(env.id = "Shenzhou",
              lat = 37.89,
              lon = 115.71,
              start.day = "01/05/2019",
              end.day = "30/10/2020") |> 
  param_radiation(merge = TRUE) |> 
  dplyr::select(env, 
                data = YYYYMMDD,
                tmed_np = T2M,
                tmax_np = T2M_MAX,
                tmin_np = T2M_MIN,
                rh_np = RH2M,
                prec_np = PRECTOT,
                n_np = n)

correlation <- 
  np |> 
  right_join(real) |> 
  dplyr::select(env, data, matches("real|np")) |> 
  pivot_longer(-c(env, data)) |> 
  separate(name, into = c("var", "method")) |> 
  pivot_wider(names_from = method, values_from = value) |> 
  separate(data, into = c("year")) 


cc1 <- 
  ggplot(correlation, aes(np, real, color = year)) + 
  facet_wrap(~var, scales = "free") +
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "NASA/POWER estimates",
       y = "Observed values") +
  my_theme


cc2 <- 
expand_grid(location = c("Shenzhou", "Gaocheng", "Handan"),
            year = c(2019, 2020),
            type = c("NASA/POWER", "Observed")) |> 
  mutate(prec = c(331, 220.2, 508, 332, 336,  218,  528, 398, 319, 201,  511, 394)) |> 
  ggplot(aes(location, prec, fill = type)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_text(aes(label = prec),
            position = position_dodge(width = 0.9),
            vjust = -0.5) +
  facet_wrap(~year) +
  scale_y_continuous(expand = expansion(c(0.05, 0.2))) +
  labs(x = "Location",
       y = "Accumulated Rainfall precipitation (mm)") +
  my_theme


arrange_ggplot(cc1, cc2,
               tag_levels = "A",
               ncol = 1)


library(metan)

correlation |> 
  group_by(var) |> 
  doo(~corr_coef(., np, real)[["cor"]] |> 
        as.data.frame()) |> 
  distinct(var, .keep_all = TRUE) |> 
  dplyr::select(var, real)

```




```{r echo=FALSE}
df_traits <- 
  import("data/df_traits.csv") |>
  metan::as_factor(1:6)

# long data
df_traits_long <- 
  df_traits |> 
  pivot_longer(GMC:HSW)


# grain yield mean in each environment
df_gy <-
  df_traits |>
  mean_by(ME, YEAR, .vars = GY)

# genotypic variance in each mega-environment
df_var_gy <- 
  df_traits |>
  group_by(YEAR, ME) |> 
  do(lmer(GY ~ (1|GEN), data = .) |>
       tidy(effects = "ran_pars") |> 
       filter(group == "GEN") |> 
       transmute(var = estimate^2))

```




# Figure S2 {-}

```{r echo=FALSE, fig.cap="biplot", message=FALSE, warning=FALSE}
env_data <- 
  readRDS("data/env_data.Rdata") |> 
  mutate(me = case_when(
    env %in% c("Yicheng") ~ "ME1",
    env %in% c("Suixi", "Jieshou", "Nanyang") ~ "ME2",
    env %in% c("Shenzhou", "Gaocheng", "Handan", "Dezhou") ~ "ME3",
    env %in% c("Laizhou", "Jinan") ~ "ME4"
  ),
  .after = env)

env_data_m <- 
  env_data |> 
  select(-daysFromStart) |> 
  mean_by(env, .vars = TMED:RTA) |> 
  column_to_rownames("env")

# compute the PCA with
pca_model <- PCA(env_data_m,
                 quali.sup = 1,
                 graph = FALSE)

fviz_contrib(pca_model, "var")


```




```{r  echo=FALSE}
id_var <- names(env_data)[11:ncol(env_data)]

names.window <- c('May','June','July','August','September', "October")

out <- 
  env_data |> 
  select(-c(env, year)) |> 
  rename(env = me) |> 
  env_typing(env.id = "env",
             var.id = id_var,
             by.interval = TRUE,
             time.window = c(0, 15, 35, 65, 90, 120),
             names.window = names.window,
             quantiles = c(.01, .25, .50, .75, .975, .99)) |> 
  separate(env.variable,
           into = c("var", "freq"),
           sep = "_",
           extra = "drop")

```



# Figure S3 {-}

```{r  echo=FALSE, fig.cap="Quantiles for Extraterrestrial radiation over six months observed in the delineated mega-environments", fig.width=10, fig.height=9}
# plot the distribution of envirotypes for dbp
variable <- "RTA"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()


```




# Figure S4 {-}
```{r  echo=FALSE, fig.cap="Quantiles for daylight hours over six months observed in the delineated mega-environments", fig.width=10, fig.height=9}
# plot the distribution of envirotypes for dbp
variable <- "N"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()

```



# Figure S5 {-}
```{r  echo=FALSE, fig.cap="Quantiles for deficit by precipitation over six months observed in the delineated mega-environments", fig.width=10, fig.height=9}
variable <- "PETP"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()



```





# Figure S6 {-}
```{r  echo=FALSE, fig.cap="Quantiles for vapor pressure deficit over six months observed in the delineated mega-environments", fig.width=10, fig.height=9}
variable <- "VPD"
# p1 <-
out |> 
  subset(var == variable) |> # change the variable here
  mutate(interval = fct_relevel(interval, month.name[5:10])) |> 
  ggplot() + 
  geom_bar(aes(x=Freq, y=env,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2)+
  facet_wrap(~interval, scales = "free", nrow = 6)+ 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()

```








# Figure S7 {-}
```{r  fig.width=12, fig.cap="Phenotypic correlation between the studied traits within ME1 (A), ME2 (B), and ME3 (C), and ME4 (D).", echo=FALSE}

mgidi_mod <- readRDS("data/mgidi.Rdata")
c1 <- mgidi_mod$mgidi[[1]]$cormat
c2 <- mgidi_mod$mgidi[[2]]$cormat
c3 <- mgidi_mod$mgidi[[3]]$cormat
c4 <- mgidi_mod$mgidi[[4]]$cormat


corM1p <- 
  c1 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)
corM2p <- 
  c2 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)
corM3p <- 
  c3 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)
corM4p <- 
  c4 |>
  network_plot(legend_position = "bottom",
               min_cor = 0.3)


arrange_ggplot(corM1p, corM2p, corM3p, corM4p,
               guides = "collect",
               tag_levels = "A")

bind_cols(corr_focus(c1, GY) |> rename(GY_ME1 = GY), 
          corr_focus(c2, GY)[,2] |> rename(GY_ME2 = GY),
          corr_focus(c3, GY)[,2] |> rename(GY_ME3 = GY),
          corr_focus(c4, GY)[,2] |> rename(GY_ME4 = GY)) 
```

# Figure S8 {-}
```{r fig.cap="Mantel's correlation between the phenotypic correlation matrices observed in each mega-environment", echo=FALSE}

pairs_mantel(as.lpcor(c1, c2, c3, c4),
             names = c("ME1", "ME2", "ME3", "ME4"))
```



# Figure S9 {- .panelset}

## ME1  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME1", echo=FALSE}
ME1 <- mgidi_mod$mgidi[[1]]$sel_gen
ME2 <- mgidi_mod$mgidi[[2]]$sel_gen
ME3 <- mgidi_mod$mgidi[[3]]$sel_gen
ME4 <- mgidi_mod$mgidi[[4]]$sel_gen

mean_me1 <- 
  df_traits |> 
  filter(ME == "ME1") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME1, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_all <- mean_by(mean_me1, name, sense)


ggplot(mean_me1, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_all,
             color = "blue") +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```


## ME2  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME2", echo=FALSE}
mean_me2 <- 
  df_traits |> 
  filter(ME == "ME2") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME2, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_me2 <- mean_by(mean_me2, name, sense)


ggplot(mean_me2, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_me2,
             color = "blue") +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```


## ME3  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME3", echo=FALSE}
mean_me3 <- 
  df_traits |> 
  filter(ME == "ME3") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME3, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_me3 <- mean_by(mean_me3, name, sense)


ggplot(mean_me3, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_me3,
             linetype = 2) +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```

## ME4  {-}

```{r fig.width=10, fig.height=6, fig.cap="Average value for the studied trait across ME4", echo=FALSE}
mean_me4 <- 
  df_traits |> 
  filter(ME == "ME4") |> 
  pivot_longer(GMC:HSW) |> 
  mutate(selected = ifelse(GEN %in% ME4, "selected", "non-selected"),
         sense = ifelse(name %in% c("BTL", "EH", "GMC", "PH"),
                        "reduce", "increase"),
         GEN = fct_relevel(GEN, paste0("G", 1:26)))
mean_traits_me4 <- means_by(mean_me4, name, sense)


ggplot(mean_me4, aes(value, GEN)) +
  geom_boxplot(aes(fill = selected),
               outlier.colour = "transparent",
               size = 0.1) +
  stat_summary(fun = mean,
               geom = "point",
               shape = "diamond") +
  facet_nested(~sense+name, scales  = "free_x") +
  geom_vline(aes(xintercept = value),
             data = mean_traits_me4,
             color = "blue") +
  labs(x = "Observed value (average)",
       y = "Genotypes") +
  theme(legend.position = "bottom") +
  my_theme
```



# Figure S10  {-}
```{r fig.width=12, fig.height=8, echo=FALSE, fig.cap="Heatmap showing the average yield of the studied genotypes in each combination of mega-environment and year"}
df_traits |> 
  concatenate(ME, YEAR, new_var = ENV) |> 
  ge_plot(ENV, GEN, GY,
          order_g = paste0("G", 1:26))
```


# Figure S11  {-}
```{r fig.width=12, fig.height=6, echo=FALSE, fig.cap="Heatmap showing the average yield of the studied genotypes in each mega-environment"}
ge_plot(df_traits, ME, GEN, GY,
        order_g = paste0("G", 1:26))
```


# Figure S12  {-}
```{r echo=FALSE,fig.cap="Quantiles for maximum air temperature (A), maximum air temperature (B), relative humidity (C), and rainfall precipitation (D) observed in the studied mega-environments across distinct crop stages and cultivation years.", fig.width=13, fig.height=10}
env_data_trial <- import("data/env_data_trial.xlsx")


names.window <- c('1-intial growing','2-leaf expansion I','3-leaf expansion II','4-flowering','5-grain filling', "")


out <- 
  env_data_trial |> 
  concatenate(ME, YEAR, .after = YEAR, new_var = env) |> 
  env_typing(env.id = c("YEAR, ME"),
             var.id = c("TMIN", "TMAX", "RH", "PRECTOT"),
             by.interval = TRUE,
             time.window = c(0, 15, 35, 65, 90, 120),
             names.window = names.window,
             quantiles = c(.01, .25, .50, .75, .975, .99)) |> 
  separate(env, into = c("ME", "YEAR")) |> 
  separate(env.variable,
           into = c("var", "freq"),
           sep = "_",
           extra = "drop")



# plot the distribution of envirotypes for dbp
variable <- "TMIN"
p3 <-
  out |> 
  subset(var == variable) |> # change the variable here
  # mutate()
  ggplot() + 
  geom_bar(aes(x=Freq, y=ME,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2) +
  facet_grid(YEAR~interval) + 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()




# plot the distribution of envirotypes for dbp
variable <- "TMAX"
p4 <-
  out |> 
  subset(var == variable) |> # change the variable here
  # mutate()
  ggplot() + 
  geom_bar(aes(x=Freq, y=ME,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2) +
  facet_grid(YEAR~interval) + 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()



# plot the distribution of envirotypes for dbp
variable <- "RH"
p5 <-
  out |> 
  subset(var == variable) |> # change the variable here
  # mutate()
  ggplot() + 
  geom_bar(aes(x=Freq, y=ME,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2) +
  facet_grid(YEAR~interval) + 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()




# plot the distribution of envirotypes for dbp
variable <- "PRECTOT"
p6 <-
  out |> 
  subset(var == variable) |> # change the variable here
  # mutate()
  ggplot() + 
  geom_bar(aes(x=Freq, y=ME,fill=freq), 
           position = "fill",
           stat = "identity",
           width = 1,
           color = "white",
           size=.2) +
  facet_grid(YEAR~interval) + 
  scale_y_discrete(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(x = 'Relative frequency',
       y = "Mega-Environment",
       fill='Envirotype')+
  theme(axis.title = element_text(size=12),
        legend.text = element_text(size=9),
        strip.text = element_text(size=12),
        legend.title = element_text(size=12),
        strip.background = element_rect(fill="gray95",size=1)) +
  ggthemes::scale_fill_stata()





arrange_ggplot(p4, p3, p5, p6,
               ncol = 1,
               tag_levels = "A")

```




# Figure S13  {-}
```{r echo=FALSE, fig.width=10, fig.height=6, echo=FALSE, fig.cap="Relationhips between accumulated rainfall precipitation and grain yield. The different colors shows the mega-environments and the different shapes, the cultivation year."}
df_gymey <- 
  df_traits |> 
  mean_by(YEAR, LOC) |> 
  select(YEAR, LOC, GY)

df_prec <- 
  env_data_trial |> 
  sum_by(ENV, YEAR, .vars = PRECTOT) |> 
  rename(LOC = ENV) |> 
  left_join(df_gymey) |> 
  mutate(ME = case_when(
    LOC %in% c("Yicheng") ~ "ME1",
    LOC %in% c("Suixi", "Jieshou", "Nanyang") ~ "ME2",
    LOC %in% c("Shenzhou", "Gaocheng", "Handan", "Dezhou") ~ "ME3",
    LOC %in% c("Laizhou", "Jinan") ~ "ME4"
  ),
  .after = LOC)



ggplot(df_prec, aes(PRECTOT, GY)) +
  geom_point(aes(color = ME, shape = YEAR), size = 4) +
  geom_smooth() +
  labs(x = "Acumulated amount of rain during the experiment (mm)",
       y = expression(Average~yield~(Mg~ha^{-1}))) +
  my_theme

```

