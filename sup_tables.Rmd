% Supplementary figures 


```{r global_options, include = FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      comment = "##",
                      collapse = TRUE,
                      warning = FALSE,
                      message = FALSE)

```



```{r warning=FALSE, message=FALSE, echo=FALSE}
library(rio)
library(tidyverse)
library(metan)
library(kableExtra)

my_theme <- 
  theme_bw() +
  theme(panel.spacing = unit(0, "cm"),
        panel.grid = element_blank(),
        legend.position = "bottom")
```



```{r  warning=FALSE, message=FALSE, echo=FALSE}

print_table = function(df,
                       caption,
                       digits = 2,
                       full_width = TRUE,
                       col.names = NA,
                       longtable = FALSE,
                       scape = FALSE,
                       html_opt = c("striped", "responsive")){
  kable(df,
        align  = "l",
        col.names = col.names,
        booktabs = T,
        digits = digits,
        format = "html",
        linesep = "",
        caption = caption,
        escape = scape,
        longtable = longtable) %>%
    kable_classic(lightable_options = "striped", html_font = "sans", full_width = full_width) %>% 
    kable_styling(bootstrap_options = html_opt)
}

```


```{r echo=FALSE}
# Include a column to mega-environment
df_traits <-
  import("paper/v4/raw_data2.csv") |> 
  metan::as_factor(1:3)


```



```{r echo=FALSE}
mod_global <- readRDS("data/mod_global.RData")
## mtsi global
SI <- 25
mtsi_global <- mtsi(mod_global, SI = SI, verbose = FALSE)
sel_gen <- mtsi_global$sel_gen
```



```{r echo=FALSE}
mod_me <- readRDS("data/mod_me.RData")
## mtsi me1
mtsi_me1 <- mtsi(mod_me$data[[1]], SI = SI, verbose = FALSE)
## mtsi me2
mtsi_me2 <- mtsi(mod_me$data[[2]], SI = SI, verbose = FALSE)
## mtsi me3
mtsi_me3 <- mtsi(mod_me$data[[3]], SI = SI, verbose = FALSE)
```


# Table S1 {-}
```{r echo=FALSE}
lrt <- 
  gmd(mod_global, "lrt") |> 
  mutate(`P-value<0.01` = ifelse(`Pr(>Chisq)` < 0.01, "yes", "no"))

print_table(lrt,
            digits = 15,
            caption = " Likelihood Ratio Test (LRT) for the random effects for each analyzed trait.")
```



# Table S2 {-}
```{r echo=FALSE}
variances <- 
  list(
    ALL = gmd(mtsi_global, "PCA"),
    ME1 = gmd(mtsi_me1, "PCA"),
    ME2 = gmd(mtsi_me2, "PCA"),
    ME3 = gmd(mtsi_me3, "PCA")
  ) |> 
  bind_rows(.id = "model")

print_table(variances, caption = "Eigenvalues and explained variance for the factor analysis acroos all environments (ALL) and within each mega-environments (ME1, ME2, and ME3).")

```




# Table S3 {-}
```{r echo=FALSE}
loadings <- 
  list(
    ALL = gmd(mtsi_global, "FA"),
    ME1 = gmd(mtsi_me1, "FA"),
    ME2 = gmd(mtsi_me2, "FA"),
    ME3 = gmd(mtsi_me3, "FA")
  ) |> 
  bind_rows(.id = "model")

print_table(loadings, caption = "Factorial loadings after varimax rotation, and communalities obtained in the factor analysis acroos all environments (ALL) and within each mega-environments (ME1, ME2, and ME3).")

```



